#!/bin/bash

# ------------------------------------------------------------------------------
# Dotfiles Management Script
# ------------------------------------------------------------------------------
# This script manages dotfiles symlinks and can be run independently
# or as part of the main bin/setup script.

BASEDIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)/.."

DOTFILES=(
    ".agents"
    ".aliases"
    "bin"
    ".claude/hooks"
    ".claude/media"
    ".claude/settings.json"
    ".claude/statusline-command.sh"
    ".codex/AGENTS.md"
    ".codex/config.toml"
    ".config/atuin/config.toml"
    ".config/tmux/is-dark-mode.sh"
    ".config/tmux/on-session-created.sh"
    ".config/tmux/run-tests.sh"
    ".config/ghostty/config"
    ".config/workmux/config.yaml"
    ".gemini/settings.json"
    ".gitconfig"
    ".gitignore"
    ".hushlogin"
    ".tmux.conf"
    ".vimrc"
    ".zprofile"
    ".zshrc"
)

CLAUDE_ONLY_DIRS=(
    "agents"
)

SHARED_AGENT_DIRS=(
    "skills"
)

MACOS_DOTFILES=(
    "Library/Application Support/lazygit/config.yml"
)

# ------------------------------------------------------------------------------
# Create dotfiles symlinks
# ------------------------------------------------------------------------------
echo "This script will create the following dotfiles:"
for i in "${DOTFILES[@]}"
do
    echo "- ~/$i"
done
for i in "${CLAUDE_ONLY_DIRS[@]}"
do
    echo "- ~/.claude/$i (from .agents/)"
done
for i in "${SHARED_AGENT_DIRS[@]}"
do
    echo "- ~/.claude/$i (from .agents/)"
    echo "- ~/.codex/$i (from .agents/)"
done
if [[ "$(uname -s)" == "Darwin" ]]; then
    for i in "${MACOS_DOTFILES[@]}"
    do
        echo "- ~/$i (macOS only)"
    done
fi

echo ""

read -p "Create these files? They will be overwritten if they exist [y/N]: " CONT
if [ "$CONT" == "y" ]; then
    create_symlink() {
        local source_path="$1"
        local target_path="$2"

        rm -rf "$target_path"

        local parent_dir
        parent_dir=$(dirname "$target_path")
        if [ "$parent_dir" != "$HOME" ] && [ ! -d "$parent_dir" ]; then
            mkdir -p "$parent_dir"
        fi

        ln -nfs "$source_path" "$target_path"
    }

    for i in "${DOTFILES[@]}"
    do
        echo "Creating $i ..."
        create_symlink "${BASEDIR}/home/$i" "$HOME/$i"
    done

    for i in "${CLAUDE_ONLY_DIRS[@]}"
    do
        echo "Creating .claude/$i ..."
        create_symlink "${BASEDIR}/home/.agents/$i" "$HOME/.claude/$i"
    done

    for i in "${SHARED_AGENT_DIRS[@]}"
    do
        echo "Creating .claude/$i ..."
        create_symlink "${BASEDIR}/home/.agents/$i" "$HOME/.claude/$i"
        echo "Creating .codex/$i ..."
        create_symlink "${BASEDIR}/home/.agents/$i" "$HOME/.codex/$i"
    done

    if [[ "$(uname -s)" == "Darwin" ]]; then
        for i in "${MACOS_DOTFILES[@]}"
        do
            echo "Creating $i ..."
            create_symlink "${BASEDIR}/home/$i" "$HOME/$i"
        done
    fi

    echo "Dotfiles symlinks created successfully!"
else
    echo "Dotfiles setup skipped."
    exit 0
fi
echo ""

# If this script is being run standalone (not sourced), reload the shell
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    echo "Reloading shell..."
    exec $SHELL -l
fi
