# Prefix key
unbind C-b
set -g prefix C-Space
bind C-Space send-prefix

# Splits
bind | split-window -h -c "#{pane_current_path}"
bind _ split-window -v -c "#{pane_current_path}"
bind ! break-pane
bind @ command-prompt -p "Send to window:" "join-pane -t :'%%'"

# Navigate windows like editor tabs
unbind [
unbind ]
bind [ previous-window
bind ] next-window

# Mouse support
set -g mouse on

# Enter copy mode on scroll (works in popups too)
bind -T root WheelUpPane if-shell -F "#{mouse_any_flag}" "send-keys -M" "if -Ft= '#{pane_in_mode}' 'send-keys -M' 'select-pane -t=; copy-mode -e; send-keys -M'"

# Reduce scroll speed (default is 5 lines per tick)
bind -T copy-mode WheelUpPane send-keys -X -N 1 scroll-up
bind -T copy-mode WheelDownPane send-keys -X -N 1 scroll-down
bind -T copy-mode-vi WheelUpPane send-keys -X -N 1 scroll-up
bind -T copy-mode-vi WheelDownPane send-keys -X -N 1 scroll-down

# Switch panes with Alt+hjkl (no prefix)
bind -n M-h select-pane -L
bind -n M-j select-pane -D
bind -n M-k select-pane -U
bind -n M-l select-pane -R

# Switch panes by number with Alt+number (no prefix)
bind -n M-1 select-pane -t 1
bind -n M-2 select-pane -t 2
bind -n M-3 select-pane -t 3
bind -n M-4 select-pane -t 4

# Resize panes
bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5

# Pane borders
set -g pane-border-lines single
set -g pane-border-status top
set -g pane-border-style default  # overridden per-mode below

# Windows
set -g base-index 1
setw -g pane-base-index 1
set -g renumber-windows on
setw -g automatic-rename off
set-hook -g session-created 'run-shell "~/.config/tmux/on-session-created.sh #{pane_current_path} #{session_name}"'

# Scrollback
set -g history-limit 10000

# Terminal title (e.g. Ghostty tab name)
set -g set-titles on
set -g set-titles-string '#S'

# Status bar layout
set -g status-position bottom
set -g status-justify centre
set -g status-left-length 30
set -g status-right-length 50
setw -g window-status-separator '  '

# Pane content colours: default lets terminal theme control fg
set -g window-style default
set -g window-active-style default

# Colours
if-shell '~/.config/tmux/is-dark-mode.sh' \
  'set -g status-style "bg=default,fg=colour231" \
  ; set -g status-left "  #[fg=colour241]#S   " \
  ; set -g status-right "#[fg=colour241]  %H:%M %a %d %b  " \
  ; setw -g window-status-format "#[bg=default,fg=colour241] ○ #W#{?@workmux_status, #{@workmux_status},} " \
  ; setw -g window-status-current-format "#[fg=colour231,bold] ● #W#{?@workmux_status, #{@workmux_status},} " \
  ; setw -g window-status-current-style "fg=colour231,bold" \
  ; set -g message-style "bg=default,fg=white" \
  ; set -g mode-style "bg=colour25,fg=white" \
  ; set -g pane-border-style "fg=colour238" \
  ; set -g pane-active-border-style "fg=colour238" \
  ; set -g pane-border-format "#{?pane_active,#[fg=colour231 bold] ● #{s/✳ //:pane_title} ,#[fg=colour241] ○ #{s/✳ //:pane_title} }"' \
  'set -g status-style "bg=default,fg=colour235" \
  ; set -g status-left "  #[fg=colour244]#S   " \
  ; set -g status-right "#[fg=colour244]  %H:%M %a %d %b  " \
  ; setw -g window-status-format "#[bg=default,fg=colour244] ○ #W#{?@workmux_status, #{@workmux_status},} " \
  ; setw -g window-status-current-format "#[bg=default,fg=colour232,bold] ● #W#{?@workmux_status, #{@workmux_status},} " \
  ; setw -g window-status-current-style "bg=default,fg=colour232,bold" \
  ; set -g message-style "bg=default,fg=colour232" \
  ; set -g mode-style "bg=colour25,fg=white" \
  ; set -g pane-border-style "fg=colour250" \
  ; set -g pane-active-border-style "fg=colour250" \
  ; set -g pane-border-format "#{?pane_active,#[fg=colour232 bold] ● #{s/✳ //:pane_title} ,#[fg=colour244] ○ #{s/✳ //:pane_title} }"'

# Run tests in popup
unbind t
bind t display-popup -E -w 80% -h 80% -d "#{pane_current_path}" "~/.config/tmux/run-tests.sh"
bind T display-popup -E -w 80% -h 80% -d "#{pane_current_path}" "~/.config/tmux/run-tests.sh true"

# Lazygit in popup
bind g display-popup -E -w 90% -h 90% -d "#{pane_current_path}" "lazygit"
bind k display-popup -E -w 90% -h 90% -d "#{pane_current_path}" "lazygit"

# Workmux
bind C-s display-popup -h 30 -w 100 -E "workmux dashboard"

# Shell popup
bind 0 display-popup -E -w 50% -h 50% -d "#{pane_current_path}" "zsh"
bind 9 display-popup -E -w 50% -h 50% -d "#{pane_current_path}" "git lg | less --mouse --wheel-lines=1 -R"

# Reload config
bind e new-window -c "#{pane_current_path}" "rubymine ."
bind r source-file ~/.tmux.conf \; display "Config reloaded"
