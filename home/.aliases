# If not running interactively, don't do anything
[ -z "$PS1" ] && return

# ------------------------------------------------------------------------------
# Directories and navigation
# ------------------------------------------------------------------------------
if [[ "$OSTYPE" == "darwin"* ]]; then
    alias ls="ls -G"
else
    alias ls="ls -A --color=auto"
fi
alias ll="ls -lh"
alias lla="ls -alh"

# ------------------------------------------------------------------------------
# Confirmation messages
# ------------------------------------------------------------------------------
alias rm='rm -iv'
alias mv='mv -iv'

# ------------------------------------------------------------------------------
# Docker
# ------------------------------------------------------------------------------
alias dcd="docker-compose down"
alias dcu="docker-compose up"

# ------------------------------------------------------------------------------
# Git
# ------------------------------------------------------------------------------
alias delete-squashed='git checkout -q master && git for-each-ref refs/heads/ "--format=%(refname:short)" | while read branch; do mergeBase=$(git merge-base master $branch) && [[ $(git cherry master $(git commit-tree $(git rev-parse $branch^{tree}) -p $mergeBase -m _)) == "-"* ]] && git branch -D $branch; done'
function gho() {
    local repo_url=`git remote get-url origin | sed -e 's/git@//' -e 's/.git//' -e 's/:/\//'`
    open "https://$repo_url"
}

function ghu() {
     local repo_url=`git remote get-url upstream | sed -e 's/git@//' -e 's/.git//' -e 's/:/\//'`
     open "https://$repo_url"
}

# Create a git worktree with a new branch and cd into it
function worktree() {
    if [ -z "$1" ]; then
        echo "Usage: worktree <branch-name>" >&2
        return 1
    fi

    local branch="$1"
    local repo_root=$(git rev-parse --show-toplevel 2>/dev/null)

    if [ -z "$repo_root" ]; then
        echo "Error: Not in a git repository" >&2
        return 1
    fi

    local repo_name=$(basename "$repo_root")
    local safe_branch="${branch//\//-}"
    local worktree_path="$(dirname "$repo_root")/${repo_name}--${safe_branch}"

    if git worktree add -b "$branch" "$worktree_path"; then
        cd "$worktree_path"
    fi
}

# Remove current git worktree and its branch, cd back to main worktree
function worktree-rm() {
    local current_path=$(git rev-parse --show-toplevel 2>/dev/null)

    if [ -z "$current_path" ]; then
        echo "Error: Not in a git repository" >&2
        return 1
    fi

    local main_worktree=$(git worktree list --porcelain | head -1 | sed 's/worktree //')

    if [ "$current_path" = "$main_worktree" ]; then
        echo "Error: Cannot remove main worktree. Run from a linked worktree." >&2
        return 1
    fi

    local branch=$(git branch --show-current)

    echo "Remove worktree at $current_path and delete branch '$branch'? [Y/n]" >&2
    read -r confirm

    if [ -z "$confirm" ] || [ "$confirm" = "y" ] || [ "$confirm" = "Y" ]; then
        if ! git worktree remove "$current_path"; then
            echo "Error: Failed to remove worktree. You may have uncommitted changes." >&2
            return 1
        fi

        cd "$main_worktree" || return 1

        if ! git branch -D "$branch"; then
            echo "Error: Failed to delete branch '$branch'." >&2
            return 1
        fi

        echo "Worktree and branch '$branch' removed."
    else
        echo "Cancelled"
        return 1
    fi
}

# Copy local configuration files from the main repository to current worktree
function worktree-setup() {
    local files_to_copy=(
        ".claude/settings.local.json"
        ".idea"
        "config/master.key"
    )

    local current_path=$(git rev-parse --show-toplevel 2>/dev/null)

    if [ -z "$current_path" ]; then
        echo "Error: Not in a git repository" >&2
        return 1
    fi

    local main_worktree=$(git worktree list --porcelain | head -1 | sed 's/worktree //')

    if [ "$current_path" = "$main_worktree" ]; then
        echo "Error: Already in main worktree. Run from a linked worktree." >&2
        return 1
    fi

    local copied=0

    for item in "${files_to_copy[@]}"; do
        local source_path="$main_worktree/$item"
        local dest_path="$current_path/$item"

        if [ -e "$source_path" ]; then
            local dest_dir=$(dirname "$dest_path")
            [ ! -d "$dest_dir" ] && mkdir -p "$dest_dir"

            if [ -d "$source_path" ]; then
                cp -r "$source_path" "$dest_path"
                echo "Copied directory: $item"
            else
                cp "$source_path" "$dest_path"
                echo "Copied file: $item"
            fi
            ((copied++))
        fi
    done

    if [ $copied -eq 0 ]; then
        echo "No files found to copy from $main_worktree"
    else
        echo "Done. Copied $copied item(s) from $main_worktree"
    fi
}

# ------------------------------------------------------------------------------
# PHP / Laravel
# ------------------------------------------------------------------------------
alias art="php artisan"
alias c="composer"
alias c1="/usr/local/bin/composer1"
alias c2="/usr/local/bin/composer"

# ------------------------------------------------------------------------------
# Ruby on Rails
# ------------------------------------------------------------------------------
alias check="./bin/check"
alias lint="./bin/lint"
alias d="./bin/dev"
alias con="bin/rails c"
alias r="./bin/rails"
alias t="./bin/rails test"
alias s="bundle exec rspec"
alias ta="./bin/rails test:all"
alias ts="./bin/rails test:system"
alias tt="./bin/rails test -f"

# ------------------------------------------------------------------------------
# Projects
# ------------------------------------------------------------------------------
alias mh="cd ~/Code/markahesketh/markhesketh.com"
alias tv="cd ~/Code/markahesketh/thevamoose.com"

# ------------------------------------------------------------------------------
# Misc
# ------------------------------------------------------------------------------
# Set terminal tab title
function tab() {
    printf '\e]1;%s\a' "$1"
}

# Reload the shell (i.e. invoke as a login shell)
function reload() {
    source ~/.zshrc
    exec $SHELL -l
}

# Add the kamal SSH key to the ssh-agent
function ssh-add-kamal() {
    eval "$(ssh-agent -s)"
    ssh-add ~/.ssh/id_ed25519_kamal
}

# Refresh dotfiles symlinks and reload shell
function dotfiles() {
    local dotfiles_dir="$HOME/Code/markahesketh/dotfiles"
    if [ -d "$dotfiles_dir" ]; then
        cd "$dotfiles_dir" && ./scripts/dotfiles.sh
    else
        echo "Dotfiles directory not found at $dotfiles_dir"
    fi
}

# Local config
[[ -f ~/.aliases.local ]] && source ~/.aliases.local
