# If not running interactively, don't do anything
[ -z "$PS1" ] && return

# ------------------------------------------------------------------------------
# Directory listing
# ------------------------------------------------------------------------------
if [[ "$OSTYPE" == "darwin"* ]]; then
    alias ls="ls -G"
else
    alias ls="ls -A --color=auto"
fi
alias ll="ls -lh"
alias lla="ls -alh"

# ------------------------------------------------------------------------------
# Confirmation messages
# ------------------------------------------------------------------------------
alias rm='rm -iv'
alias mv='mv -iv'

# ------------------------------------------------------------------------------
# Docker
# ------------------------------------------------------------------------------
alias dcd="docker-compose down"
alias dcu="docker-compose up"

# ------------------------------------------------------------------------------
# Git
# ------------------------------------------------------------------------------
alias delete-squashed='git checkout -q master && git for-each-ref refs/heads/ "--format=%(refname:short)" | while read branch; do mergeBase=$(git merge-base master $branch) && [[ $(git cherry master $(git commit-tree $(git rev-parse $branch^{tree}) -p $mergeBase -m _)) == "-"* ]] && git branch -D $branch; done'
function gho() {
    local repo_url=`git remote get-url origin | sed -e 's/git@//' -e 's/.git//' -e 's/:/\//'`
    open "https://$repo_url"
}

function ghu() {
     local repo_url=`git remote get-url upstream | sed -e 's/git@//' -e 's/.git//' -e 's/:/\//'`
     open "https://$repo_url"
}

function worktree() {
    if [ -z "$1" ]; then
        echo "Usage: worktree <branch-name>"
        return 1
    fi
    local branch="$1"
    local repo_root=$(git rev-parse --show-toplevel 2>/dev/null)
    if [ -z "$repo_root" ]; then
        echo "Error: Not in a git repository"
        return 1
    fi
    local repo_name=$(basename "$repo_root")
    local worktree_path="$(dirname "$repo_root")/${repo_name}--${branch}"

    git worktree add -b "$branch" "$worktree_path" && cd "$worktree_path"
}

function worktree-rm() {
    local current_path=$(git rev-parse --show-toplevel 2>/dev/null)
    if [ -z "$current_path" ]; then
        echo "Error: Not in a git repository"
        return 1
    fi

    # Get main worktree (first line of git worktree list)
    local main_worktree=$(git worktree list --porcelain | head -1 | sed 's/worktree //')

    if [ "$current_path" = "$main_worktree" ]; then
        echo "Error: Cannot remove main worktree. Run from a linked worktree."
        return 1
    fi

    local branch=$(git branch --show-current)

    echo "Remove worktree at $current_path and delete branch '$branch'? [Y/n]"
    read -r confirm
    if [ -z "$confirm" ] || [ "$confirm" = "y" ] || [ "$confirm" = "Y" ]; then
        cd "$main_worktree"
        git worktree remove "$current_path"
        git branch -D "$branch"
        echo "Worktree and branch '$branch' removed. Now in $main_worktree"
    else
        echo "Cancelled"
    fi
}

# ------------------------------------------------------------------------------
# PHP / Laravel
# ------------------------------------------------------------------------------
alias art="php artisan"
alias c="composer"
alias c1="/usr/local/bin/composer1"
alias c2="/usr/local/bin/composer"

# ------------------------------------------------------------------------------
# Ruby on Rails
# ------------------------------------------------------------------------------
alias check="./bin/check"
alias lint="./bin/lint"
alias d="./bin/dev"
alias con="bin/rails c"
alias r="./bin/rails"
alias t="./bin/rails test"
alias s="bundle exec rspec"
alias ta="./bin/rails test:all"
alias ts="./bin/rails test:system"
alias tt="./bin/rails test -f"

# ------------------------------------------------------------------------------
# Projects
# ------------------------------------------------------------------------------
alias mh="cd ~/Code/markahesketh/markhesketh.com"
alias tv="cd ~/Code/markahesketh/thevamoose.com"

# ------------------------------------------------------------------------------
# Misc
# ------------------------------------------------------------------------------
# Set terminal tab title
function tab() {
    printf '\e]1;%s\a' "$1"
}

# Reload the shell (i.e. invoke as a login shell)
function reload() {
    source ~/.zshrc
    exec $SHELL -l
}

# Add the kamal SSH key to the ssh-agent
function ssh-add-kamal() {
    eval "$(ssh-agent -s)"
    ssh-add ~/.ssh/id_ed25519_kamal
}

# Refresh dotfiles symlinks and reload shell
function dotfiles() {
    local dotfiles_dir="$HOME/Code/markahesketh/dotfiles"
    if [ -d "$dotfiles_dir" ]; then
        cd "$dotfiles_dir" && ./scripts/dotfiles.sh
    else
        echo "Dotfiles directory not found at $dotfiles_dir"
    fi
}

# Local config
[[ -f ~/.aliases.local ]] && source ~/.aliases.local
