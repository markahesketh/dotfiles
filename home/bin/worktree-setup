#!/bin/bash
#
# Copy local configuration files from the main repository to a worktree
#

# Files and directories to copy
FILES_TO_COPY=(
    ".claude/settings.local.json"
    ".idea"
    "config/master.key"
)

set -e

current_path=$(git rev-parse --show-toplevel 2>/dev/null)

if [ -z "$current_path" ]; then
    echo "Error: Not in a git repository" >&2
    exit 1
fi

# Get main worktree (first line of git worktree list)
main_worktree=$(git worktree list --porcelain | head -1 | sed 's/worktree //')

if [ "$current_path" = "$main_worktree" ]; then
    echo "Error: Already in main worktree. Run from a linked worktree." >&2
    exit 1
fi

copied=0

for item in "${FILES_TO_COPY[@]}"; do
    source_path="$main_worktree/$item"
    dest_path="$current_path/$item"

    if [ -e "$source_path" ]; then
        # Create parent directory if needed
        dest_dir=$(dirname "$dest_path")
        if [ ! -d "$dest_dir" ]; then
            mkdir -p "$dest_dir"
        fi

        # Copy file or directory
        if [ -d "$source_path" ]; then
            cp -r "$source_path" "$dest_path"
            echo "Copied directory: $item"
        else
            cp "$source_path" "$dest_path"
            echo "Copied file: $item"
        fi
        ((copied++))
    fi
done

if [ $copied -eq 0 ]; then
    echo "No files found to copy from $main_worktree"
else
    echo "Done. Copied $copied item(s) from $main_worktree"
fi
